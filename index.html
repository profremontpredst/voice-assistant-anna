<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∫–æ–º–ø–∞–Ω–∏—è ¬´–ï—Å—Ç—å –†–µ—à–µ–Ω–∏–µ¬ª</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #f9f9f9;
      color: #333;
    }
    header {
      background-color: #003366;
      color: white;
      text-align: center;
      padding: 20px;
    }
    .hero {
      padding: 40px 20px;
      background: #e3f2fd;
      text-align: center;
    }
    #chat {
      max-width: 540px;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      min-height: 200px;
      white-space: pre-wrap;
      line-height: 1.6;
    }
    .chat-msg {
      margin-bottom: 14px;
    }
    .chat-user {
      color: #1565c0;
      font-weight: bold;
    }
    .chat-bot {
      color: #008f57;
      font-weight: bold;
    }
    #input-area {
      max-width: 540px;
      margin: 10px auto 40px auto;
      display: flex;
      gap: 8px;
      padding: 0 10px;
    }
    #user-input {
      flex: 1;
      padding: 10px;
      font-size: 16px;
    }
    #send-btn, #mic-btn {
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 14px;
      cursor: pointer;
    }
    footer {
      text-align: center;
      background: #003366;
      color: white;
      padding: 20px;
    }
    @media (max-width: 600px) {
      #input-area {
        flex-direction: column;
      }
    }
    #lead-form-overlay {
      display:none;
      position:fixed;
      top:0; left:0;
      width:100vw; height:100vh;
      background:rgba(0,0,0,0.5);
      z-index:1000;
      justify-content:center;
      align-items:center;
    }
    #lead-form-box {
      background:white;
      padding:20px;
      border-radius:10px;
      width:90%;
      max-width:400px;
      position:relative;
    }
    #lead-form-box button.close-btn {
      position:absolute;
      top:10px;
      right:10px;
      font-size:18px;
      background:none;
      border:none;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <header>
    <h1>–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∫–æ–º–ø–∞–Ω–∏—è ¬´–ï—Å—Ç—å –†–µ—à–µ–Ω–∏–µ¬ª</h1>
  </header>
  <section class="hero">
    <h2>–°–ø–∏—Å–∞–Ω–∏–µ –¥–æ–ª–≥–æ–≤ —á–µ—Ä–µ–∑ –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–æ</h2>
    <p>–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è. –Æ—Ä–∏—Å—Ç –æ–Ω–ª–∞–π–Ω.</p>
  </section>

  <div id="chat"></div>

  <div id="input-area">
    <input type="text" id="user-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
    <button id="send-btn">‚Üí</button>
    <button id="mic-btn">üé§</button>
  </div>

  <footer>
    <p>¬© 2025 –Æ–ö ¬´–ï—Å—Ç—å –†–µ—à–µ–Ω–∏–µ¬ª</p>
  </footer>

  <!-- –õ–∏–¥-—Ñ–æ—Ä–º–∞ -->
  <div id="lead-form-overlay">
    <div id="lead-form-box">
      <button class="close-btn" onclick="closeLeadForm()">‚úï</button>
      <h3>–û—Å—Ç–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É</h3>
      <p>–ú—ã –ø–µ—Ä–µ–∑–≤–æ–Ω–∏–º –≤–∞–º –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è</p>
      <form id="lead-form" onsubmit="submitLead(event)">
        <input type="text" id="name" placeholder="–í–∞—à–µ –∏–º—è" required style="width:100%;padding:10px;margin-bottom:10px;">
        <input type="tel" id="phone" value="+7" required maxlength="12" style="width:100%;padding:10px;margin-bottom:10px;">
        <button type="submit" style="width:100%;padding:10px;background:#003366;color:white;border:none;border-radius:5px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </form>
    </div>
  </div>

  <script>
    const OPENAI_PROXY_URL = "https://openai-gpt-proxy-sdox.onrender.com/gpt";
    const LEAD_URL = "https://openai-gpt-proxy-sdox.onrender.com/lead";

    let userId = localStorage.getItem("userId");
    if (!userId) {
      userId = "user_" + Math.random().toString(36).substr(2, 9);
      localStorage.setItem("userId", userId);
    }

    const chat = document.getElementById("chat");
    const input = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const micBtn = document.getElementById("mic-btn");

    let chatHistory = [];

    function renderChat() {
      chat.innerHTML = chatHistory.map(m => {
        const role = m.role === "user" ? "chat-user" : "chat-bot";
        const label = m.role === "user" ? "üßë –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:" : "ü§ñ –ê–Ω–Ω–∞:";
        return `<div class="chat-msg"><span class="${role}">${label}</span> ${escapeHTML(m.content)}</div>`;
      }).join("");
      chat.scrollTop = chat.scrollHeight;
    }

    function escapeHTML(str) {
      return String(str).replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    async function sendMessage(text) {
      chatHistory.push({ role: "user", content: text });
      renderChat();
      input.value = "";
      const res = await fetch(OPENAI_PROXY_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId, messages: chatHistory.slice(-10) })
      });
      const data = await res.json();
      const reply = data.choices?.[0]?.message?.content || "‚ùå GPT –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª";
      if (data.choices?.[0]?.message?.triggerForm) openLeadForm();
      chatHistory.push({ role: "assistant", content: reply });
      renderChat();
    }

    sendBtn.onclick = () => {
      const text = input.value.trim();
      if (text) sendMessage(text);
    };

    input.addEventListener("keypress", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendBtn.click();
      }
    });

    micBtn.onclick = async () => {
      try {
        const text = await recognizeSpeech();
        if (text) sendMessage(text);
      } catch (err) {
        alert("–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: " + err);
      }
    };

    function recognizeSpeech(timeout = 10000) {
      return new Promise((resolve, reject) => {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) return reject("SpeechRecognition –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
        const rec = new SpeechRecognition();
        rec.lang = "ru-RU";
        rec.interimResults = false;
        const timer = setTimeout(() => {
          rec.stop(); reject("‚è±Ô∏è –¢–∞–π–º–∞—É—Ç");
        }, timeout);
        rec.onresult = (e) => {
          clearTimeout(timer);
          rec.stop();
          resolve(e.results[0][0].transcript);
        };
        rec.onerror = (e) => {
          clearTimeout(timer);
          rec.stop();
          reject(e.error || "–û—à–∏–±–∫–∞");
        };
        rec.start();
      });
    }

    function openLeadForm() {
      document.getElementById('lead-form-overlay').style.display = 'flex';
      document.getElementById('lead-form').reset();
    }

    function closeLeadForm() {
      document.getElementById('lead-form-overlay').style.display = 'none';
    }

    async function submitLead(event) {
      event.preventDefault();
      const name = document.getElementById("name").value.trim();
      let rawPhone = document.getElementById("phone").value.replace(/\D/g, "");
      if (rawPhone.startsWith("8")) rawPhone = "7" + rawPhone.slice(1);
      if (rawPhone.startsWith("9")) rawPhone = "7" + rawPhone;
      if (!/^7\d{10}$/.test(rawPhone)) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä");
      const phone = "+" + rawPhone;
      closeLeadForm();
      await fetch(LEAD_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId, name, phone })
      });
      chatHistory.push({ role: "assistant", content: "–°–ø–∞—Å–∏–±–æ! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏." });
      renderChat();
    }

    document.getElementById("phone").addEventListener("input", function () {
      if (!this.value.startsWith("+7")) this.value = "+7";
      const digits = this.value.slice(2).replace(/\D/g, "").slice(0, 10);
      this.value = "+7" + digits;
    });
  </script>
</body>
</html>
