<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∫–æ–º–ø–∞–Ω–∏—è ¬´–ï—Å—Ç—å –†–µ—à–µ–Ω–∏–µ¬ª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script>
    let userId = localStorage.getItem("userId");
    if (!userId) {
      userId = "user_" + Math.random().toString(36).substr(2, 9);
      localStorage.setItem("userId", userId);
    }
  </script>
  <style>/* —Å—Ç–∏–ª–∏ –ø—Ä–æ–ø—É—â–µ–Ω—ã –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ */</style>
</head>
<body>
<header>
  <h1>–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∫–æ–º–ø–∞–Ω–∏—è ¬´–ï—Å—Ç—å –†–µ—à–µ–Ω–∏–µ¬ª</h1>
</header>
<!-- –æ—Å—Ç–∞–ª—å–Ω–æ–π html –ø—Ä–æ–ø—É—â–µ–Ω –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ -->
<script>
  const OPENAI_PROXY_URL = "https://openai-gpt-proxy-sdox.onrender.com/gpt";
  const STREAM_URL = "https://elevenlabs-proxy-c781.onrender.com/stream";
  const LEAD_URL = "https://openai-gpt-proxy-sdox.onrender.com/lead";

  let messages = [];
  let isRunning = false;
  let greeted = false;
  let chatHistory = [];
  let sessionHistory = [];

  function renderChat() {
    const chat = document.getElementById('chat');
    chat.innerHTML = chatHistory.map(msg => {
      if (msg.role === "user") return `<div class="chat-msg"><span class="chat-user">üßë –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</span> ${escapeHTML(msg.content)}</div>`;
      if (msg.role === "assistant") return `<div class="chat-msg"><span class="chat-bot">ü§ñ –ê–Ω–Ω–∞:</span> ${escapeHTML(msg.content)}</div>`;
      return '';
    }).join("");
    chat.scrollTop = chat.scrollHeight;
  }

  function escapeHTML(str) {
    return String(str).replace(/</g, "&lt;").replace(/>/g, "&gt;");
  }

  async function recognizeSpeech(timeout = 10000) {
    return new Promise((resolve, reject) => {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) return reject("SpeechRecognition –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
      const recognition = new SpeechRecognition();
      recognition.lang = "ru-RU";
      recognition.interimResults = false;
      const timer = setTimeout(() => {
        recognition.stop();
        reject("‚è±Ô∏è –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ");
      }, timeout);
      recognition.onresult = (event) => {
        clearTimeout(timer);
        recognition.stop();
        const text = event.results[0][0].transcript;
        resolve(text);
      };
      recognition.onerror = (err) => {
        clearTimeout(timer);
        recognition.stop();
        reject(err.error || "–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è");
      };
      recognition.start();
    });
  }

  async function askGPT(messages) {
    const res = await fetch(OPENAI_PROXY_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId, messages: messages.slice(-10) })
    });
    const data = await res.json();
    if (data.choices?.[0]?.message?.triggerForm) openLeadForm();
    return data.choices?.[0]?.message?.content || "‚ùå GPT –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª";
  }

  async function playTTS(text) {
    const indicator = document.getElementById("voice-indicator");
    indicator.style.display = "block";
    const res = await fetch(STREAM_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text })
    });
    const audioBlob = new Blob([await res.arrayBuffer()], { type: "audio/mpeg" });
    if (audioBlob.size < 1000) {
      indicator.style.display = "none";
      return;
    }
    const audioUrl = URL.createObjectURL(audioBlob);
    const audio = document.getElementById("audio-player");
    audio.src = audioUrl;
    audio.load();
    await audio.play().catch(() => {});
    await new Promise(resolve => {
      audio.onended = resolve;
      audio.onerror = resolve;
    });
    indicator.style.display = "none";
  }

  async function dialogLoop() {
    if (isRunning) return;
    isRunning = true;

    try {
      if (!greeted) {
        greeted = true;
        const reply = "<prosody rate='medium'><emphasis level='moderate'>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!</emphasis> –Ø –ê–Ω–Ω–∞, –≤–∞—à –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç. <break time='400ms'/> –ú–æ–∂–µ—Ç–µ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å ‚Äî —è –ø–æ–º–æ–≥—É —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è.</prosody>";
        sessionHistory.push({ role: "assistant", content: reply });
        chatHistory.push({ role: "assistant", content: reply });
        renderChat();
        await playTTS(reply);
      }

      while (true) {
        await new Promise(r => setTimeout(r, 600));
        const userText = await recognizeSpeech();
        sessionHistory.push({ role: "user", content: userText });
        chatHistory.push({ role: "user", content: userText });
        renderChat();

        const reply = await askGPT(sessionHistory);
        sessionHistory.push({ role: "assistant", content: reply });
        chatHistory.push({ role: "assistant", content: reply });
        renderChat();

        await playTTS(reply);
      }
    } catch (err) {
      console.warn("üí• –û—à–∏–±–∫–∞:", err);
    } finally {
      isRunning = false;
      try {
        await fetch("https://script.google.com/macros/s/AKfycbwjw69VW-8l0_Sb-1-vXMVF1gRUeOVpQoxzpVsAuS5ZLWrdu3HPa_CAX8Oq0mHTYBbG/exec", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_id: userId,
            dialog: sessionHistory.map(m => `${m.role}: ${m.content}`).join("\n")
          })
        });
      } catch (e) {
        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∏–∞–ª–æ–≥:", e);
      }
    }
  }

  document.getElementById("mic-btn").onclick = () => {
    if (!isRunning) {
      renderChat();
      dialogLoop();
    }
  };

  function openLeadForm() {
    document.getElementById('lead-form-overlay').style.display = 'flex';
    document.getElementById('lead-form').reset();
    setTimeout(() => {
      document.getElementById('name').focus();
    }, 200);
  }

  function closeLeadForm() {
    document.getElementById('lead-form-overlay').style.display = 'none';
  }

  async function submitLead(event) {
    event.preventDefault();
    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    if (!/^\+7\s?9\d{2}\s?\d{3}-\d{2}-\d{2}$/.test(phone)) {
      alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7 9xx xxx-xx-xx");
      return;
    }
    closeLeadForm();
    const res = await fetch(LEAD_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId, name, phone })
    });
    const data = await res.json();
    const msg = data.message || "–°–ø–∞—Å–∏–±–æ! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏.";
    sessionHistory.push({ role: "assistant", content: msg });
    chatHistory.push({ role: "assistant", content: msg });
    renderChat();
    await playTTS(msg);
  }

  document.getElementById("phone").addEventListener("input", function(e) {
    let val = this.value.replace(/\D/g, "");
    if (val.startsWith("89")) val = "9" + val.slice(2);
    if (val.startsWith("79")) val = val.slice(1);
    if (val.length > 10) val = val.slice(0, 10);
    let result = "+7";
    if (val.length > 0) result += " " + val.slice(0, 3);
    if (val.length > 3) result += " " + val.slice(3, 6);
    if (val.length > 6) result += "-" + val.slice(6, 8);
    if (val.length > 8) result += "-" + val.slice(8, 10);
    this.value = result;
  });

  window.openLeadForm = openLeadForm;
</script>
</body>
</html>
